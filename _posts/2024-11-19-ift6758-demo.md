---
layout: post
title: IFT6758 Milestone 2
---



## 1: Introduction

Pour évaluer la performance en sport, les analystes utilisent les **buts attendus** (xG) pour mesurer la qualité des tirs. Contrairement à un simple décompte des buts ou tirs, cette mesure repose sur la **probabilité de réussite d’un tir** en fonction de caractéristiques spécifiques. Les données sont modélisées pour prédire la probabilité qu’un tir se traduise par un but, offrant ainsi un indicateur plus précis des chances de marquer.

---
## 2: Ingénierie des Caractéristiques I

### **2.1.Question 1:**

#### a) Histogramme de la Distance

La **Figure 2.1.1** illustre la distribution des tirs en fonction de leur distance par rapport au filet :

- La majorité des tirs sont effectués à moins de **65 pieds** du filet, avec un pic significatif près du filet.
- Les buts suivent une distribution logarithmique, avec une probabilité de réussite plus élevée pour les tirs à **moins de 25 pieds**.
- Au-delà de cette distance, bien que le nombre de tirs reste relativement élevé, la probabilité de marquer diminue de manière significative.
- Une longue queue est observée dans les distributions des tirs et des buts, traduisant des valeurs extrêmes rares mais existantes.

![Histogramme de la distance](../public/images/HistogrammeDistance.png)
*Fig. 2.1.1 : Histogramme du nombre de tirs, regroupés par distance par rapport au filet.*

---

#### b) Histogramme de l’Angle

La **Figure 2.1.2** montre la distribution des tirs selon leur angle par rapport au filet :

- Les tirs et les buts suivent une distribution globale normale centrée autour de **0°** (en ligne droite vers le filet).
- Les tirs depuis le centre (0°) sont les plus fréquents et présentent un taux de réussite élevé.
- Les tirs pris sous des angles extrêmes (proches de ±40° ou plus) sont moins efficaces, avec moins de buts marqués.
- Des extremums locaux sont observés autour de **±40°**, traduisant une direction de tir préférée par certains joueurs. Cependant, cela ne se traduit pas par une augmentation significative des buts, révélant une faible efficacité pour ces tirs particuliers.

![Histogramme de l'angle](../public/images/HistogrammeNombreTirs.png)
*Fig. 2.1.2 : Histogramme du nombre de tirs, regroupés par angle par rapport au filet.*

---
#### c) Histogramme 2D (Distance vs. Angle)

La **Figure 2.1.3** combine distance et angle dans un histogramme 2D, montrant leur relation dans les tirs et les buts :

- Les tirs les plus réussis sont concentrés près du centre du filet et à **moins de 50 pieds**.
- À des distances plus élevées, seuls les tirs centrés (angles proches de 0°) aboutissent à des buts.
- Les tirs pris à des distances et angles extrêmes sont beaucoup moins susceptibles de réussir, confirmant les observations des histogrammes de distance et d’angle.

![Histogramme 2D](../public/images/RelationDistanceTir.png)
*Fig. 2.1.3 : Relation entre la distance et l'angle de tir.*

D’autres alternatives pour les histogrammes 2D que nous avons représentés sont comme suit et peuvent également être adoptés pour l’analyse.

![Histogramme 2D](../public/images/RelationDistanceTir2.png)
*Fig. 2.2.3 : Relation entre la distance et l'angle de tir.*

![Histogramme 2D](../public/images/RelationDistanceTir3.png)
*Fig. 2.2.3 : Relation entre la distance et l'angle de tir.*

---
### **2.2.Question 2:**

### Taux de Buts en Fonction de la Distance

La **Figure 2.2.1** montre la relation entre le taux de buts et la distance par rapport au filet :

- **Proximité du filet** : Le taux de buts est **élevé à proximité immédiate du filet**, atteignant **100 %** pour les distances proches de 0 pied.  
- **Diminution avec la distance** : Le taux de réussite diminue rapidement à mesure que la distance au filet augmente.  
- **Tirs à longue distance (≥ 115 pieds)** : Une tendance intéressante est observée pour les tirs à longue distance, qui semblent être **disproportionnellement plus réussis** par rapport aux distances moyennes. Cette anomalie peut s'expliquer par plusieurs facteurs :  
  1. **Filet vide** : En fin de match, une équipe en retard peut retirer son gardien pour ajouter un attaquant supplémentaire, augmentant les chances de réussite des tirs lointains.  
  2. **Situations spéciales** : Tirs pendant un désavantage numérique ou dégagements conduisant à des buts inattendus.  
  3. **Artefacts dans les données** : 
     - Tirs mal classifiés ou enregistrés incorrectement.  
     - Tirs de longue distance qui surprennent les équipes adverses (bien que ce soit marginal).

![Taux de buts par distance](../public/images/TauxDeButs.png)
*Fig. 2.2.1 : Taux de buts en fonction de la distance par rapport au filet.*

### Taux de Buts en Fonction de l’Angle

La **Figure 2.2.2** analyse le taux de buts en fonction de l’angle du tir par rapport au filet :

- **Angles entre -90° et 90°** :
  - Les tirs pris **de face (0°)** présentent un **taux de réussite plus élevé**, bien que limité.  
  - À mesure que l’angle augmente en valeur absolue, le taux de réussite diminue, confirmant que les tirs sous des angles larges sont moins efficaces.  
- **Angles extrêmes (≥ ±140°)** : Une tendance notable est observée :
  - Certains tirs pris depuis des angles extrêmes enregistrent un **taux de réussite de 100 %**.  
  - Explications possibles :
    1. **Tirs stratégiques** : Tirs intentionnels depuis derrière le filet, espérant des rebonds contre le gardien ou un autre joueur.  
    2. **Rebonds intentionnels** : Tirs calculés pour dévier de manière imprévisible.  
    3. **Filet vide** : Opportunités créées par une absence de gardien.  
    4. **Artefacts de données** : 
       - Mesures incorrectes ou saisies erronées des positions, entraînant des angles mal évalués.  

![Taux de buts par angle](../public/images/TauxDeButsAngle.png)
*Fig. 2.2.2 : Taux de buts en fonction de l'angle du tir par rapport au filet.*

---
## 3: Modèles de base
#### **3.1.Précision des modèles et biais potentiel:**

**Question 1 :**  
Lors de l’utilisation de la caractéristique `distanceFromNet`, le modèle de régression logistique atteint une précision d’environ **90,5 %** sur l’ensemble de validation, tandis qu’elle est légèrement supérieure, à **90,6 %**, en utilisant `angleFromNet` (voir Fig. 3.1.1). Cela signifie que dans environ **90 % des cas**, le modèle prédit correctement si un tir est un but ou non.

Cependant, une limitation importante émerge des valeurs prédites (`pred_probs`) renvoyées par la fonction `clf.predict_proba(X_val)`. La deuxième colonne des probabilités prédites, qui correspond à la probabilité qu’un tir soit un but (classe 1), montre une prédominance de faibles valeurs (Fig. 3.1.2). Ce comportement est révélateur d’un **biais du modèle** dû à un déséquilibre des classes dans les données : les tirs non réussis (classe 0) sont beaucoup plus fréquents que les buts (classe 1). Par conséquent, le modèle favorise la classe majoritaire pour maximiser la précision, au détriment des prédictions de la classe minoritaire.

Pour pallier ce problème, plusieurs approches peuvent être envisagées :
- **Rééchantillonnage** : Suréchantillonner les buts ou sous-échantillonner les tirs non réussis.
- **Rééquilibrage des données** : Pondérer les classes pour équilibrer leur importance.
- **Utilisation de métriques alternatives** : Privilégier le F1-score ou d’autres métriques adaptées aux ensembles déséquilibrés.
- **Modèles plus sophistiqués** : Explorer les arbres de décision, forêts aléatoires ou méthodes d’ensemble.

![Précision des modèles de régression logistique](../public/images/PrecisionLogistic.png)
*Fig. 3.1.1 Précision des modèles de régression logistique*

![Probabilités prédites](../public/images/ProbabilitePLogistic.png)
*Fig. 3.1.2 Probabilités prédites des modèles de régression logistique*

#### **3.2.Analyse Comparative des Modèles:**

#### Questions 2 et 3

Trois classifieurs de régression logistique ont été évalués en utilisant :
1. La distance (`distance`),
2. L'angle (`angle`),
3. La combinaison de la distance et de l'angle (`distance + angle`).

Les performances des modèles sont analysées à travers plusieurs représentations graphiques :
#### 3.2.1. Comprendre les Représentations
Les courbes ROC sont couramment utilisées pour représenter les taux de vrais positifs (TP) en fonction des taux de faux positifs (FP) pour différents seuils de classification. Plus un modèle est performant (c’est-à-dire qu’il parvient à bien distinguer les deux classes, **no-Goal** et **Goal**), plus la courbe ROC se rapproche de la valeur 1 sur l’axe des ordonnées (représentant les vrais positifs). L’AUC (aire sous la courbe ROC) fournit une mesure globale de la performance du modèle sur l’ensemble des seuils de classification. Une AUC de 1,0 indique un modèle prédictif parfait. Les autres types de courbes, moins connues, seront expliqués dans les sections suivantes.


### A) Taux de Buts en Fonction du Centile de la Probabilité de Tir

Cette analyse permet d’évaluer comment les probabilités prédites par le modèle se traduisent en taux de buts réels pour différents segments de probabilité. L’objectif est d’examiner la fréquence des buts en fonction des centiles de la probabilité de but prédite. Les étapes de cette méthode sont les suivantes :

- Les probabilités de buts prédites sont divisées en centiles (par exemple, 10e, 20e, ..., 90e centile).
- Pour chaque centile, le **taux de buts** est calculé comme le nombre de buts divisé par le nombre total de tirs (buts et non-buts) dans ce segment.

Par exemple, si une probabilité de tir se situe dans le **70e centile**, cela signifie qu’elle est plus élevée que 70 % des autres probabilités de l’ensemble des données.

---

### B) Proportion Cumulée de Buts en Fonction du Centile de la Probabilité de Tir

Cette analyse mesure la capacité du modèle à capturer les buts les plus probables. Elle consiste à examiner **la proportion cumulative de buts observés** par rapport aux centiles de probabilité prédite :

- On cumule les buts en partant des probabilités les plus faibles jusqu’aux probabilités les plus élevées.
- Pour chaque centile, on calcule la **proportion des buts**, c’est-à-dire le nombre de buts cumulés divisé par le total des buts dans l’ensemble des données.

Par exemple, si **80 % des buts réels** sont capturés dans les **50 premiers centiles**, cela indique que les tirs avec les probabilités les plus faibles (les 50 % inférieurs) incluent une grande partie des buts observés.

---

### C) Diagramme de Fiabilité (Courbe de Calibration)

Le diagramme de fiabilité évalue si les probabilités prédites par le modèle correspondent aux probabilités observées dans les données. Voici comment il est construit :

- **Abscisse** : Les probabilités prédites, regroupées en intervalles (par exemple, 0.0-0.1, 0.1-0.2, etc.).
- **Ordonnée** : Le taux de réussite observé dans chaque intervalle de probabilité.

Un modèle bien calibré produit une courbe qui suit une ligne diagonale, indiquant une correspondance parfaite entre les probabilités prédites et les probabilités observées.

---

Ces analyses permettent de mieux comprendre les performances du modèle et son comportement vis-à-vis des probabilités qu’il génère.

---
#### 3.2.2. Interprétation des résultats

## Courbes ROC

Les courbes ROC permettent d’évaluer la capacité des modèles à distinguer entre les tirs réussis (*buts*) et non réussis (*non-buts*). En analysant la **Figure 3.3.1**, on constate que les modèles de régression logistique basés sur la caractéristique **distance au filet** (seule ou combinée avec l'angle) offrent une meilleure performance que ceux utilisant uniquement **l'angle**. 

- Les modèles basés sur la **distance** s'approchent davantage du coin supérieur gauche de la courbe ROC, atteignant une **AUC** d’environ **0,7** (respectivement 0,69 et 0,7).  
- En revanche, le modèle utilisant uniquement l'**angle** obtient une AUC de **0,50**, ce qui équivaut à une prédiction aléatoire. Cela suggère que l'**angle** n’est pas une caractéristique pertinente dans ce contexte.  

Même lorsque la **distance** et l'**angle** sont combinés, les performances restent comparables à celles obtenues avec la **distance seule**, confirmant ainsi que la distance est le facteur clé.

![Courbes ROC](../public/images/TauxFauxPositif.png)
*Fig. 3.3.1 : Courbes ROC pour les modèles utilisant `distance`, `angle`, et `distance + angle`, comparées à une référence aléatoire.*

---
## Taux de Buts par Centile de Probabilité

La **Figure 3.3.2** illustre la fréquence des buts en fonction des centiles des probabilités prédites. Tracer le taux de buts par centile permet d’évaluer si le modèle favorise les tirs ayant des probabilités élevées dans certains centiles.

- La **référence aléatoire** est représentée par une ligne horizontale à **10 %**. Elle suppose une distribution égale des buts quelle que soit la probabilité.  
- Les modèles utilisant la **distance** ou **distance + angle** montrent une **tendance décroissante**. Cela indique qu’ils attribuent un taux de but plus élevé aux tirs ayant des scores de probabilité plus importants, démontrant ainsi leur bonne performance.  
- Les tirs associés à des probabilités élevées (selon ces modèles) se traduisent par des taux de réussite plus importants.

Comme pour les **courbes ROC**, ces modèles affichent des courbes quasi-identiques :  
- **Taux supérieur à la référence** pour les tirs appartenant aux centiles les plus élevés (≥70 %).  
- **Taux inférieur à la référence** pour les tirs appartenant aux centiles les plus bas, ce qui reflète leur capacité à identifier les tirs de meilleure qualité.  
Ces résultats confirment que la **distance** est une caractéristique essentielle pour prédire les buts.

En revanche, le modèle basé uniquement sur **l’angle** présente un comportement différent :
- Il affiche un taux de but légèrement plus élevé autour du **50e centile**, mais **sous-estime** les probabilités élevées.  
- Ses taux sont **irréguliers**, ce qui révèle une faible capacité à discriminer les tirs réussis des non-réussis.  
Ainsi, ce modèle n’est pas fiable pour estimer la probabilité de but et ne permet pas une forte séparation entre les deux classes.

![Courbes ROC](../public/images/CentileModeleProbabilteTir.png)
*Fig. 3.3.2 : Centiles du modèle de probabilités de tir*

---

## Proportion Cumulée de Buts

---
layout: post
title: "Analyse des Modèles : Proportion Cumulative de Buts"
date: 2024-11-20
categories: [machine learning, analyse sportive, modélisation]
tags: [modèles, proportion cumulative, classification, Jekyll]
---

## Proportion Cumulative de Buts

La **Figure 3.3.3** illustre la proportion cumulative des buts par centile de probabilité prédite. Ce graphique permet d’évaluer la capacité des modèles à capturer efficacement les tirs les plus probables de se transformer en buts.

### Analyse des Courbes
- **Courbe cyan (« Distance et Angle du Filet »)** : Cette courbe démontre une **meilleure couverture des buts** dans les centiles supérieurs, ce qui confirme que ce modèle identifie efficacement les tirs ayant les probabilités les plus élevées de devenir des buts.  
- **Modèle basé uniquement sur l'angle** :  
  - Ce modèle attribue **moins de poids aux buts dans les centiles supérieurs** (probabilités >50 %).  
  - Par exemple, au **centile 50**, la courbe occupe moins de la moitié de l’aire, ce qui montre une couverture insuffisante des buts.  
  - La courbe est **presque linéaire**, ce qui indique une faible capacité à discriminer entre les tirs réussis et non réussis.  
- **Modèles basés sur la distance (seule ou combinée avec l’angle)** :  
  - Ces modèles montrent une **pente initiale abrupte**, ce qui reflète leur capacité à capturer rapidement une large proportion des buts.  
  - Par exemple, **50 % des buts** sont capturés dans les **30 % des centiles les plus élevés**, ce qui en fait des outils performants pour identifier les tirs les plus susceptibles de réussir.  

![Proportion cumulative de buts](../public/images/PourcentageCumulatifButs.png)
*Fig. 3.3.3 : Pourcentage Cumulatif de Buts.*

---
## Graphiques de Calibration

Les graphiques de calibration permettent de vérifier si les probabilités prédites par le modèle correspondent aux probabilités observées dans les données réelles. Une calibration idéale se traduit par une courbe suivant parfaitement la ligne diagonale (noire en pointillé), qui indique une correspondance parfaite entre les prédictions et les résultats observés.

### Analyse des Courbes
- **Courbe cyan (« Distance et Angle du Filet »)** :  
  - Ce modèle est **relativement bien calibré** pour les probabilités faibles et moyennes.  
  - Cependant, pour les probabilités élevées, on observe une **surestimation** des buts, ce qui suggère que des ajustements supplémentaires pourraient être nécessaires pour améliorer la calibration dans cette plage.  
- **Performance globale** :  
  - Parmi les options disponibles, le modèle combinant **distance et angle** est celui qui se rapproche le plus d’une calibration parfaite.  
- **Limites communes** :  
  - Les trois modèles se regroupent dans le coin inférieur gauche du graphique, avec une **fraction de positifs inférieure à 0,2**, ce qui reflète le faible nombre de buts par rapport au total des tirs.  
  - Aucun des modèles n’attribue une probabilité très élevée aux buts, ce qui peut être dû à la rareté relative des buts dans les données.


![Graphique de Callibration](../public/images/GraphiquesCallibration.png)
*Fig. 3.3.4.: Courbes de calibration pour les modèles de régression logistique entraînés avec la distance, l'angle, ou les deux (distance et angle), comparées à une référence aléatoire.*


#### **3.3.Suivi des Expériences Wandb :**
### Questions 4 
Les trois modèles ont été enregistrés dans Wandb. Voici les liens vers chaque modèle et les expériences associées :

#### Modèles Enregistrés sur Wandb
1. **Régression logistique entraînée uniquement sur la distance** :  
   [Lien vers le modèle](https://wandb.ai/thalia-cantero-udem/Milestone2_Q3/artifacts/model/log_reg_distance_model)  
2. **Régression logistique entraînée uniquement sur l'angle** :  
   [Lien vers le modèle](https://wandb.ai/thalia-cantero-udem/Milestone2_Q3/artifacts/model/log_reg_angle_model)  
3. **Régression logistique entraînée sur la distance et l'angle** :  
   [Lien vers le modèle](https://wandb.ai/thalia-cantero-udem/Milestone2_Q3/artifacts/model/log_reg_distance_angle_model)

---

#### Expériences Associées
1. **Expérience pour la régression logistique sur la distance** :  
   [Lien vers l’expérience](https://wandb.ai/thalia-cantero-udem/Milestone2_Q3/runs/e7oopxjt?nw=nwuserkhalidag)  
2. **Expérience pour la régression logistique sur l’angle** :  
   [Lien vers l’expérience](https://wandb.ai/thalia-cantero-udem/Milestone2_Q3/runs/3hlbqme8?nw=nwuserkhalidag)  
3. **Expérience pour la régression logistique sur distance + angle** :  
   [Lien vers l’expérience](https://wandb.ai/thalia-cantero-udem/Milestone2_Q3/runs/eoc7px60?nw=nwuserkhalidag)

---
conclusion: apres l analyse des courbes en precedents, on peut conclure que le nhl est un grand defi et chalengeux 

## 4:Ingénierie des caractéristiques II
Au fil des étapes, nous avons conçu et extrait diverses caractéristiques pour enrichir notre modèle. Ces caractéristiques sont regroupées en quatre catégories principales :

#### 1. **Caractéristiques de base :**
- **`gameSeconds`** : Nombre total de secondes écoulées depuis le début du jeu (calculé à partir des données disponibles dans les fichiers JSON).
- **`emptynet`** : Indique si le tir a été effectué contre un filet vide (1) ou non (0).
- **`period`** : Période actuelle du jeu (1, 2 ou 3).
- **`coordinateX` et `coordinateY`** : Coordonnées de l’événement sur la patinoire (le centre de la patinoire étant défini comme (0,0)).
- **`distance`** : Distance en pieds entre le filet cible et l’endroit où le tir a eu lieu.
- **`angle`** : Angle en degrés entre le filet et l’endroit où le tir a eu lieu, mesuré depuis la perspective du gardien de but (un angle de 0° correspond à un tir directement devant le filet).
- **`shotType`** : Type de tir (ex. : slap shot, wrist shot).

#### 2. **Caractéristiques basées sur l’événement précédent :**
- **`lastEvent`** : Type d’événement immédiatement précédent ce tir (un parmi tous les événements possibles).
- **`lastCoordinateX` et `lastCoordinateY`** : Coordonnées (X, Y) de l’événement immédiatement précédent ce tir.
- **`timeLastEvent`** : Temps écoulé entre le tir actuel et l’événement immédiatement précédent (en secondes).
- **`lastDistance`** : Distance en pieds entre l’emplacement de l’événement précédent et celui du tir actuel.

#### 3. **Caractéristiques avancées :**
- **`rebound`** : Indique si l’événement précédent était également un tir (1) ou non (0).
- **`chang_angle`** : Si l’événement précédent était un tir, représente le changement d’angle entre les deux tirs.
- **`speed`** : Distance entre l’événement précédent et le tir actuel, divisée par le temps écoulé.
- **`vitesse_chang_angle`** : Si l’événement précédent était un tir, représente la vitesse de changement d’angle entre les deux tirs.

#### 4. **Caractéristiques bonus :**
- **`non_gardiens_amicaux`** : Nombre de patineurs alliés (hors gardien) présents sur la glace.
- **`non_gardiens_adverses`** : Nombre de patineurs adverses (hors gardien) présents sur la glace.
- **`temps_PP`** : Temps écoulé depuis le début du jeu de puissance (power play), exprimé en secondes.


---

### Illustrations des calculs

#### a) **`gameSeconds`** : 
Le calcul a été réalisé en déterminant les secondes totales écoulées par période de jeu.
```
# Calculer les secondes de jeu en fonction de la période et du temps dans la période
def calculate_game_seconds(row):
    minutes, seconds = map(int, row['periodTime'].split(':'))
    return (row['period'] - 1) * 1200 + minutes * 60 + seconds
```

#### b) **`distance` et `angle`** :
Les caractéristiques de distance et d’angle ont été calculées à partir des coordonnées des événements :

```
def calcul_distance_angle(df):
    # Initialiser la liste des distances et le dictionnaire des côtés défensifs par période pour chaque ligne
    distances = []
    angles = []
    home_defending_side_period = {1: None, 2: None, 3: None}
    angle = None
    distance = None

    # Boucler sur chaque ligne pour calculer les distances
    for index, row in df.iterrows():
        # Initialiser la distance à None pour chaque ligne
        
        # Extraire les informations pertinentes
        x = row['coordinateX']
        y = row['coordinateY']
        event_team_id = row['eventTeamId']
        home_team_id = row['teamHomeId']
        defending_side = row.get('homeTeamDefendingSide', None)
        zone_code = row.get('zoneCode', None)
        period = row.get('period', None)
        season = row.get('season', None)
        
        # Vérifier la saison et définir les conditions de calcul
        if zone_code is not None:
            if event_team_id == home_team_id and period in home_defending_side_period:
                if home_defending_side_period[period] is None:
                    home_defending_side_period[period] = 'right' if x > 0 else 'left'

            if zone_code == "D":
                if x > 0:
                    distance = math.sqrt((x + 89)**2 + y**2)
                    angle = np.arctan2(y, x+89)
                elif x < 0:
                    distance = math.sqrt((89 - x)**2 + y**2)
                    angle = np.arctan2(y, 89-x)

            elif zone_code == "O":
                if x > 0:
                    distance = math.sqrt((89 - x)**2 + y**2)
                    angle = np.arctan2(y, 89-x)
                elif x < 0:
                    distance = math.sqrt((x + 89)**2 + y**2)
                    angle = np.arctan2(y, x+89)

            elif zone_code == "N" and period in home_defending_side_period:
                if event_team_id == home_team_id:
                    if home_defending_side_period[period] == 'right':
                        distance = math.sqrt((x + 89)**2 + y**2)
                        angle = np.arctan2(y, x+89)
                    elif home_defending_side_period[period] == 'left':
                        distance = math.sqrt((89 - x)**2 + y**2)
                        angle = np.arctan2(y, 89-x)
                else:
                    if home_defending_side_period[period] == 'right':
                        distance = math.sqrt((89 - x)**2 + y**2)
                        angle = np.arctan2(y, 89-x)
                    elif home_defending_side_period[period] == 'left':
                        distance = math.sqrt((x + 89)**2 + y**2)
                        angle = np.arctan2(y, x+89)

        if angle is not None:
            angle = round(np.rad2deg(angle), 4)

        distances.append(distance)
        angles.append(angle)

    # Ajouter les distances calculées au DataFrame
    df['distance'] = distances
    # Ajouter les angles calculés au DataFrame
    df['angle'] = angles

    return df
```

#### c) **Caractéristiques basées sur l’événement précédent :**
Les calculs pour `lastCoordinateX`, `lastCoordinateY`, `lastEvent`, `timeLastEvent`, `lastDistance`, `rebound`, et `speed` ont été obtenus à l’aide des fonctions `get_distance` et `get_time_diff` définies comme suit :

```
for i in range(len(plays)):
    play = plays[i]
    if play["typeDescKey"] in ["shot-on-goal", "goal"]:
        last_details = plays[i-1].get("details", {}) if i > 0 else {}
        details = play.get("details", {})

```

```
        lastCoordinateX = last_details.get("xCoord", None)
        lastCoordinateY = last_details.get("yCoord", None)
        if lastCoordinateX is None:
            lastCoordinateX = 0
        if lastCoordinateY is None:
            lastCoordinateY = 0
        
        lastEvent = plays[i-1].get("typeDescKey", None)
        periodTime = plays[i].get("timeInPeriod", None)
        lastPeriodTime = plays[i-1].get("timeInPeriod", None)
        
        lastDistance = get_distance(coordinateX, coordinateY, lastCoordinateX, lastCoordinateY)
        timeLastEvent = get_time_diff(periodTime, lastPeriodTime)
        
        rebound = False
        rebound = lastEvent == "shot-on-goal"
        speed = lastDistance / timeLastEvent if timeLastEvent else 0

```
```
import numpy as np
import math

def get_distance(x1, y1, x2, y2):
    try:
        distance = math.sqrt((x2 - x1)**2 + (y2 - y1)**2)
    except:
        distance = 0
    return distance

```

```
# Get time difference
import datetime as dt

def get_time_diff(t1, t2):
    start_dt = dt.datetime.strptime(t1, '%M:%S')
    end_dt = dt.datetime.strptime(t2, '%M:%S')
    diff = (end_dt - start_dt)
    return diff.seconds

```

#### d) **Caractéristiques avancées :**
Les calculs pour `chang_angle` et `vitesse_chang_angle` sont illustrés ci-dessous :

```
import pandas as pd
import numpy as np

df3['chang_angle'] = 0  # Initialisez avec 0
df3['vitesse_chang_angle'] = 0  # Initialisez avec 0

# Boucle pour calculer le changement d'angle et la vitesse
for i in range(1, len(df3)):  # Commencez à 1 pour éviter les erreurs sur l'indice -1
    if df3.loc[i, 'rebound']:  # Si c'est un rebond
        angle_actuel = df3.loc[i, 'angle']
        angle_precedent = df3.loc[i - 1, 'angle']
        temps_ecoule = df3.loc[i, 'timeLastEvent']

        # Calcul du changement d'angle
        changement_angle = abs(180 - (angle_actuel + angle_precedent))
        df3.loc[i, 'chang_angle'] = changement_angle

        # Calcul de la vitesse du changement d'angle
        if temps_ecoule:
            df3.loc[i, 'vitesse_chang_angle'] = changement_angle / temps_ecoule
        else:
            df3.loc[i, 'vitesse_chang_angle'] = 0

```
---

### Question 4 : Bonus

Les caractéristiques bonus, telles que `non_gardiens_amicaux` et `non_gardiens_adverses`, ont été extraites à partir du champ `situationCode` des fichiers JSON. Voici la logique appliquée :
- **`non_gardiens_amicaux`** : Nombre de patineurs alliés (hors gardien) présents sur la glace.
- **`non_gardiens_adverses`** : Nombre de patineurs adverses (hors gardien) présents sur la glace.
- **`temps_PP`** : Temps écoulé en situation de power play.

---

### Question 5 : Enregistrer le sous-ensemble filtré avec WandB

Un sous-ensemble des données, filtré pour inclure uniquement le match Winnipeg contre Washington du 12 mars 2018, a été enregistré dans WandB. Les caractéristiques finales incluent toutes les colonnes mentionnées ci-dessus.

**Lien vers l’expérience WandB :**  
[Visualisation des données pour Winnipeg vs Washington (12 mars 2018)](https://wandb.ai/thalia-cantero-udem/ingenieurie_char_data?nw=nwuserkhalidag)





